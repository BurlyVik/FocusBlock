<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quizlet Topic to JSON Formatter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      line-height: 1.6;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    .main {
      flex: 1;
      min-width: 0; /* prevent overflow */
    }
    .history {
      flex: 0 auto; /* shrink to fit content */
      background: #fff;
      padding: 15px;
      border-left: 2px solid #ccc;
      max-height: 90vh;
      overflow-y: auto;
      white-space: nowrap; /* prevent titles from wrapping on desktop */
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      margin-bottom: 15px;
      resize: vertical;
      box-sizing: border-box;
    }
    textarea {
      height: 200px;
    }
    textarea.formatted {
      height: 400px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-bottom: 20px;
      cursor: pointer;
      width: 100%; /* full width on mobile */
      box-sizing: border-box;
    }
    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
    .radio-options {
      display: flex;
      gap: 20px;
      margin: 8px 0 20px 0;
      flex-wrap: wrap;
    }
    .radio-options label {
      font-weight: normal;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .history h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    .history ol {
      padding-left: 20px;
      margin: 0;
    }
    .history li {
      margin-bottom: 8px;
    }
    .history a {
      color: #0066cc;
      text-decoration: none;
      cursor: pointer;
    }
    .history a:hover {
      text-decoration: underline;
    }
    .clear-btn {
      background: #f44336;
      color: white;
      border: none;
      margin-bottom: 15px;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
    }

    /* --- Responsive --- */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      .history {
        border-left: none;
        border-top: 2px solid #ccc;
        margin-top: 20px;
        width: 100%;
        white-space: normal; /* allow wrapping on small screens */
      }
      button {
        font-size: 14px;
        padding: 8px 14px;
      }
    }
  </style>
</head>
<body>
  <div class="main">
    <h1>Quizlet Topic to JSON Q/A Formatter</h1>

    <!-- NEW Search input -->
    <label for="searchQuery">Search Quizlet Flash Cards:</label>
    <input type="text" id="searchQuery" placeholder="Enter search term (e.g. CompTIA A+)" />
    <button onclick="searchQuizlet()">Search Quizlet</button>

    <label for="topicUrl">Paste Quizlet Topic URL:</label>
    <input type="text" id="topicUrl" placeholder="https://quizlet.com/1065912616/wgu-d431-flash-cards/" />

    <button onclick="openApiUrl()">Open Modified JSON URL (1000 items)</button>

    <label for="rawInput">Paste Raw JSON Response:</label>
    <textarea id="rawInput" placeholder="Paste raw JSON here..."></textarea>

    <label>Question Organization:</label>
    <div class="radio-options">
      <label><input type="radio" name="order" value="initial" checked> Initial Order</label>
      <label><input type="radio" name="order" value="shuffle"> Shuffle Questions</label>
    </div>

    <button onclick="convert()">Convert JSON to Q/A Format</button>

    <label for="output">Formatted Output:</label>
    <textarea id="output" class="formatted" placeholder="Formatted output will appear here..."></textarea>

    <button onclick="storeAndProceed()">Next: Open Flashcards</button>
  </div>

  <div class="history">
    <h2>History</h2>
    <button class="clear-btn" onclick="clearHistory()">Clear History</button>
    <ol id="historyList"></ol>
  </div>

  <script>
    // --- Search Quizlet ---
    function searchQuizlet() {
      const query = document.getElementById("searchQuery").value.trim();
      if (!query) {
        alert("Enter a search term.");
        return;
      }
      const searchUrl = `https://quizlet.com/search?query=${encodeURIComponent(query)}&type=sets&useOriginal=`;
      window.open(searchUrl, "_blank");
    }

    function openApiUrl() {
      const input = document.getElementById("topicUrl").value.trim();
      const match = input.match(/quizlet\.com\/(\d+)\//);

      if (!match) {
        alert("Invalid topic URL.");
        return;
      }

      const topicId = match[1];
      const apiUrl = `https://quizlet.com/webapi/3.4/studiable-item-documents?filters[studiableContainerId]=${topicId}&filters[studiableContainerType]=1&perPage=1000&page=1`;

      window.open(apiUrl, '_blank');

      saveUrlToHistory(input);
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function convert() {
      const rawText = document.getElementById('rawInput').value;
      const outputBox = document.getElementById('output');
      outputBox.value = '';

      let parsed;
      try {
        parsed = JSON.parse(rawText);
      } catch (err) {
        outputBox.value = "Invalid JSON: " + err.message;
        return;
      }

      const items = parsed?.responses?.[0]?.models?.studiableItem;

      if (!items || typeof items !== 'object') {
        outputBox.value = "Could not find 'studiableItem' data.";
        return;
      }

      const results = [];

      for (const key in items) {
        const item = items[key];
        const sides = item.cardSides;
        if (!sides || sides.length < 2) continue;

        const word = sides[0]?.media?.[0]?.plainText ?? '';
        const definition = sides[1]?.media?.[0]?.plainText ?? '';

        if (word && definition) {
          results.push({ q: word, a: definition });
        }
      }

      const orderChoice = document.querySelector('input[name="order"]:checked').value;
      if (orderChoice === "shuffle") {
        shuffleArray(results);
      }

      outputBox.value = JSON.stringify(results, null, 2);
    }

    function storeAndProceed() {
      const outputText = document.getElementById('output').value.trim();
      const topicUrl = document.getElementById('topicUrl').value.trim();
        
      if (!outputText) {
        alert("No formatted JSON to store. Please convert first.");
        return;
      }
      try {
        JSON.parse(outputText);
      } catch (err) {
        alert("Formatted output is not valid JSON.");
        return;
      }
    
      localStorage.setItem("flashcard_data", outputText);
    
      if (topicUrl) {
        localStorage.setItem("flashcard_source_url", topicUrl);
      
        const match = topicUrl.match(/quizlet\.com\/\d+\/([^/]+)/);
        if (match && match[1]) {
          const rawTitle = match[1].replace(/-/g, " ");
          const title = rawTitle.charAt(0).toUpperCase() + rawTitle.slice(1);
          localStorage.setItem("flashcard_topic_title", title);
        } else {
          localStorage.setItem("flashcard_topic_title", "Quizlet-Style Flashcards");
        }
      }
    
      window.open("flashcards.html", "_blank");
    }

    // --- History handling ---
    function saveUrlToHistory(url) {
      if (!url) return;
      let history = JSON.parse(localStorage.getItem("quizlet_url_history") || "[]");
      if (!history.includes(url)) {
        history.unshift(url); // add to top
        if (history.length > 20) history.pop(); // keep last 20
        localStorage.setItem("quizlet_url_history", JSON.stringify(history));
      }
      renderHistory();
    }

    function renderHistory() {
      const history = JSON.parse(localStorage.getItem("quizlet_url_history") || "[]");
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      history.forEach(url => {
        const li = document.createElement("li");
        const a = document.createElement("a");

        // Extract topic title slug (after numeric ID)
        const match = url.match(/quizlet\.com\/\d+\/([^/]+)/);
        let title = url;
        if (match && match[1]) {
          title = match[1].replace(/-/g, " ");
          // Capitalize nicely
          title = title.replace(/\b\w/g, c => c.toUpperCase());
        }

        a.textContent = title;
        a.href = "#";
        a.onclick = (e) => {
          e.preventDefault();
          document.getElementById("topicUrl").value = url;
        };

        li.appendChild(a);
        list.appendChild(li);
      });
    }

    function clearHistory() {
      localStorage.removeItem("quizlet_url_history");
      renderHistory();
    }

    // Load history on startup
    renderHistory();
  </script>
</body>
</html>
