<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quizlet-Style Flashcards</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f6f7fb;
    color: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
  }
  h1 {
    font-size: 1.6rem;
    margin-bottom: 1.2rem;
    font-weight: 600;
    color: #333;
    text-align: center;
  }
  #qCount {
    margin-bottom: 1.2rem;
    font-size: 1rem;
    font-weight: 500;
    color: #666;
    text-align: center;
  }

  .flashcard-container {
    display: flex;
    align-items: stretch;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    max-width: 960px;
    flex-wrap: wrap;
  }
  .flashcard {
    flex: 1 1 50%;
    max-width: 500px;
    min-height: 320px;
    perspective: 1200px;
  }
  .card {
    width: 100%;
    height: 320px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s ease;
    border-radius: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    cursor: pointer;
    background: #fff;
  }
  .card.flipped { transform: rotateY(180deg); }
  .side {
    position: absolute;
    inset: 0;
    padding: 1.5rem;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 1.05rem;
    font-weight: 500;
    line-height: 1.5;
    backface-visibility: hidden;
    overflow-y: auto;
    word-wrap: break-word;
  }
  .front { background: #fff; }
  .back { transform: rotateY(180deg); background: #fafafa; }
  .options {
    flex: 1 1 40%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 0.75rem;
  }
  .option {
    padding: 0.9rem 1rem;
    border: 1px solid #d0d0d0;
    border-radius: 10px;
    background: #fff;
    font-size: 1rem;
    line-height: 1.4;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    word-break: break-word;
    white-space: normal;
  }
  .option:hover {
    border-color: #999;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .option.selected { border: 2px solid #555; background: #eef0ff; }
  .option.correct { border: 2px solid #2e7d32; background: #c8e6c9; }
  .option.wrong { border: 2px solid #e67e22; background: #ffe0b3; }
  .controls-row {
    margin-top: 1.2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
  }
  button {
    padding: 0.55rem 1.1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    background: #1976d2;
    color: #fff;
    transition: background 0.2s ease;
  }
  button:hover { background: #1259a9; }
  .bookmark-btn {
    font-size: 1.3rem;
    background: transparent;
    color: #666;
    padding: 0.3rem 0.6rem;
  }
  .bookmark-btn.bookmarked { color: #f4b400; }
  #showBookmarkedBtn.show-bookmarked {
    background: #ffc107;
    color: #333;
  }
  #feedback {
    margin-top: 0.8rem;
    min-height: 24px;
    font-size: 1.05rem;
    font-weight: 500;
    text-align: center;
  }
  .card-hint {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    font-style: italic;
    color: #474747;
    text-align: center;
  }
  .hint-note {
    margin-top: 0.6rem;
    font-size: 0.9rem;
    font-style: italic;
    color: #555;
    text-align: center;
  }
  .back-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #0066cc;
    color: white;
    border: none;
    padding: 8px 14px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    border-radius: 4px;
    z-index: 1000;
  }
  .back-btn:hover { background: #004999; }
</style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='index.html'">← Back</button>
  <h1 id="flashTitle"><a id="flashLink" href="#" target="_blank">Quizlet-Style Flashcards</a></h1>
  <div id="qCount">Loading...</div>
  <div class="flashcard-container">
    <div class="flashcard" onclick="flipCard(event)">
      <div class="card" id="card">
        <div class="side front" id="question">Loading...</div>
        <div class="side back" id="answer">Loading...</div>
      </div>
      <div class="card-hint">Click card to reveal answer</div>
    </div>
    <div class="options" id="options"></div>
  </div>
  <div class="controls-row">
    <button class="bookmark-btn" id="bookmarkBtn" onclick="toggleBookmark()" title="Bookmark">&#9734;</button>
    <button onclick="prevCard()">< Prev</button>
    <button onclick="nextCard()">Next ></button>
    <button onclick="submitAnswer()" id="submitBtn">Submit</button>
    <button onclick="showMissedQuestions()">Missed</button>
    <button onclick="toggleShowBookmarked()" id="showBookmarkedBtn">Bookmarked</button>
  </div>
  <div class="hint-note">Tip: Use your mouse scroll wheel to cycle through questions quicker</div>
  <div id="feedback"></div>

<script>
let cards = [];
let current = 0;
let answered = false;
let missedQuestions = [];
let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions') || "[]");
let showOnlyBookmarked = false;
let bookmarkedOrder = [];
// Save per-card state: { correct: true/false, chosen: "text", answers: [array in fixed order] }
let answerStates = {};

(function initFromLocalStorage() {
  const raw = localStorage.getItem("flashcard_data");
  if (!raw) return showNoCards("No flashcards found.");
  try {
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) return showNoCards("No flashcards found.");
    cards = parsed;
    updateBookmarkedOrder();
    current = 0;
    showCard(current);
  } catch { showNoCards("Failed to load flashcards."); }
})();

function showNoCards(msg) {
  document.getElementById("question").innerText = msg;
  document.getElementById("answer").innerText = "";
  document.getElementById("qCount").innerText = "No questions";
  document.getElementById("options").innerHTML = "";
}

function showCard(index) {
  document.getElementById('card').classList.remove('flipped');
  document.getElementById('question').innerText = cards[index].q;
  document.getElementById('answer').innerText = cards[index].a;
  answered = !!answerStates[index]?.hasOwnProperty("correct");
  document.getElementById('feedback').innerText = '';
  document.getElementById('submitBtn').disabled = answered;
  showOptions(index);
  updateBookmarkStar();
  updateCountDisplay();
}

function flipCard(e) {
  if (e.target.classList.contains("option") || e.target.classList.contains("bookmark-btn")) return;
  document.getElementById('card').classList.toggle('flipped');
}

function nextCard() {
  const arr = showOnlyBookmarked ? bookmarkedOrder : cards.map((_, i) => i);
  if (arr.length === 0) return;
  current = arr[(arr.indexOf(current) + 1) % arr.length];
  showCard(current);
}
function prevCard() {
  const arr = showOnlyBookmarked ? bookmarkedOrder : cards.map((_, i) => i);
  if (arr.length === 0) return;
  current = arr[(arr.indexOf(current) - 1 + arr.length) % arr.length];
  showCard(current);
}
let wheelTimeout;
window.addEventListener("wheel", (e) => {
  e.preventDefault();
  clearTimeout(wheelTimeout);
  wheelTimeout = setTimeout(() => {
    if (e.deltaY > 0) nextCard();
    else if (e.deltaY < 0) prevCard();
  }, 100);
}, { passive: false });

function showOptions(index) {
  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';
  const correct = cards[index].a;

  // Use stored answers if they exist, otherwise generate & save
  let answers;
  if (answerStates[index]?.answers) {
    answers = answerStates[index].answers;
  } else {
    let wrongs = cards.filter((c, i) => i !== index).map(c => c.a);
    wrongs = wrongs.sort(() => 0.5 - Math.random()).slice(0, 2);
    answers = [correct, ...wrongs].sort(() => 0.5 - Math.random());
    if (!answerStates[index]) answerStates[index] = {};
    answerStates[index].answers = answers;
  }

  answers.forEach(ans => {
    const div = document.createElement('div');
    div.className = 'option';
    div.innerText = ans;
    div.onclick = () => selectOption(div, ans, correct);
    optionsDiv.appendChild(div);

    // Restore state
    if (answerStates[index]?.chosen) {
      if (answerStates[index].hasOwnProperty("correct")) {
        if (ans === correct) div.classList.add("correct");
        if (!answerStates[index].correct && ans === answerStates[index].chosen) {
          div.classList.add("wrong");
        }
      } else {
        if (ans === answerStates[index].chosen) {
          div.classList.add("selected"); // ✅ restore gray if not yet submitted
        }
      }
    }
  });
}

function selectOption(div, ans) {
  if (answered) return;
  document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
  div.classList.add('selected');   // ✅ gray highlight on click
  if (!answerStates[current]) answerStates[current] = {};
  answerStates[current].chosen = ans;
}

function submitAnswer() {
  if (answered || !answerStates[current]?.chosen) return;
  answered = true;
  const correct = cards[current].a.trim();
  const chosen = answerStates[current].chosen;
  document.querySelectorAll('.option').forEach(o => {
    const optText = o.innerText.trim();
    if (optText === correct) o.classList.add('correct');
    if (optText === chosen && optText !== correct) o.classList.add('wrong');
    o.onclick = null;
  });
  if (chosen === correct) {
    document.getElementById('feedback').innerText = 'Correct!';
    answerStates[current].correct = true;
  } else {
    document.getElementById('feedback').innerText = 'Incorrect.';
    answerStates[current].correct = false;
    if (!missedQuestions.some(q => q.q === cards[current].q && q.a === cards[current].a)) {
      missedQuestions.push(cards[current]);
    }
  }
  document.getElementById('submitBtn').disabled = true;
}

function updateBookmarkStar() {
  const btn = document.getElementById('bookmarkBtn');
  btn.innerHTML = bookmarks.includes(current) ? '&#9733;' : '&#9734;';
  btn.classList.toggle('bookmarked', bookmarks.includes(current));
}
function toggleBookmark() {
  const idx = bookmarks.indexOf(current);
  if (idx === -1) bookmarks.push(current);
  else bookmarks.splice(idx, 1);
  localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
  updateBookmarkStar();
  updateBookmarkedOrder();
}
function updateBookmarkedOrder() {
  bookmarkedOrder = bookmarks.slice();
  if (showOnlyBookmarked && !bookmarkedOrder.includes(current)) {
    if (bookmarkedOrder.length > 0) {
      current = bookmarkedOrder[0];
      showCard(current);
    } else showNoCards("No bookmarked cards.");
  }
}
function toggleShowBookmarked() {
  showOnlyBookmarked = !showOnlyBookmarked;
  document.getElementById('showBookmarkedBtn').classList.toggle('show-bookmarked', showOnlyBookmarked);
  updateBookmarkedOrder();
  const arr = showOnlyBookmarked ? bookmarkedOrder : cards.map((_, i) => i);
  if (arr.length > 0) {
    current = arr.includes(current) ? current : arr[0];
    showCard(current);
  } else showNoCards("No bookmarked cards.");
}
function updateCountDisplay() {
  const arr = showOnlyBookmarked ? bookmarkedOrder : cards.map((_, i) => i);
  document.getElementById('qCount').innerText = arr.length
    ? `Question ${arr.indexOf(current)+1} of ${arr.length}`
    : 'No questions';
}
function showMissedQuestions() {
  document.getElementById("missedContainer")?.remove();
  const missedDiv = document.createElement("div");
  missedDiv.id = "missedContainer";
  missedDiv.innerHTML = '<h2>Missed Questions:</h2>';
  missedQuestions.length
    ? missedQuestions.forEach((q,i)=>{missedDiv.innerHTML+=`<p><strong>Q${i+1}:</strong> ${q.q}<br><strong>A:</strong> ${q.a}</p>`;})
    : missedDiv.innerHTML += '<p>None! Great job!</p>';
  document.body.appendChild(missedDiv);
}
document.getElementById("flashLink").href = localStorage.getItem("flashcard_source_url") || "#";
document.getElementById("flashLink").textContent = localStorage.getItem("flashcard_topic_title") || "Quizlet-Style Flashcards";
</script>
</body>
</html>
